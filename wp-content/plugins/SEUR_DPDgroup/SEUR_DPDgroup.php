<?php
/*
 * Plugin Name:       SEUR - DPDgroup
 * Plugin URI:        https://sugo.es
 * Description:       Crear envios, crear recogidas, listado de manifiesto, seguimiento de envios, consulta de tarifas, consulta nomenclator, todo esto y más en su panel Wordpress.
 * Version:           1.1.2
 * Author:            SUGO - Con la colaboración de SEUR MURCIA, dpto. informatica.
 * Author URI:        https://sugo.es
 * Text Domain:       seur
 * License:           GPL-2.0+
 * License URI:       Permitido su uso solo a clientes de SEUR.
 * Domain Path:       /languages
 * Requirements: 	  PHP 5.5.0 or above, WordPress 4.0 or above, WooCommerce 2.6 or above.
 * 
 */
if ( !defined( 'ABSPATH' ) )  exit ; function SEUR() { return SEUR_integracion::get_instance(); } add_action( 'plugins_loaded', 'seur') ; class SEUR_integracion { public $VERSION = '1.1.2' ; protected $plugin_slug = 'seur' ; protected static $instance = null ; public $plugin_dir ; public $plugin_path ; public $plugin_url ; public $plugin_local ; public $BasePath ; public $BaseCache ; public $If_WC = false ; public $CodLang ; private function __construct() { if ( !class_exists( 'SEUR_AdminPageFramework' ) && !include_once( plugin_dir_path( __FILE__ ). 'includes/apf/admin-page-framework.php' )) { return ; } else { $this->If_WC =  $this->is_active( 'woocommerce/woocommerce.php' ) ; $this->plugin_local = trailingslashit(plugin_dir_path( __FILE__ )) ; $this->plugins_path = trailingslashit(dirname(plugin_dir_path(__FILE__))) ; $this->BasePath		= trailingslashit(dirname(dirname($this->plugins_path))) ; $this->BaseCache	= $this->BasePath . 'wp-content/cache/seur/' ; $this->plugin_dir 	= trailingslashit( basename( $this->plugin_local ) ) ; $this->plugin_url 	= plugins_url().'/'.$this->plugin_dir ; $domain = $this->plugin_slug ; $locale = apply_filters( 'plugin_locale', get_locale(), $domain ) ; $this->CodLang = $locale ; load_textdomain( $domain, trailingslashit( WP_LANG_DIR ) . $domain . '/' . $domain . '-' . $locale . '.mo' ) ; load_plugin_textdomain($domain, FALSE, basename( plugin_dir_path( dirname( __FILE__ ) ) ) . '/languages/' ) ; if ($this->If_WC) { require_once( plugin_dir_path( __FILE__ ).  'includes/clases/API_Class.php' ) ; if( ($old_options = get_option('SEUR_admin')) !== false ) { update_option('SEUR_SUGO', $old_options) ; delete_option('SEUR_admin') ;  } $this->API = new SEUR_API('SEUR_SUGO') ; add_action( 'plugins_loaded', array( $this, 'SEUR_end_plugin_Load'),11) ; add_action( 'init', array( $this, 'inicializo' ), 50 ) ; } else { $this->adminNotice(__('No se ha encontrado Woocommerce activado, SEUR - DPDgroup necesita que esté activado para su correcto funcionamiento.','seur'), 'error') ;  } add_action( 'shutdown', array( $this, 'SEUR_end_works'), 0) ;  }  } public function inicializo() { require_once( plugin_dir_path( __FILE__ ).  'includes/clases/SEUR_connect_Class.php' ) ; $this->SOAP = new SEUR_connect() ; if(is_admin()) { require_once($this->plugin_local . '/admin/SEUR_main_menu.php'  ) ; $this->admin = new SEUR_admin('SEUR_SUGO') ; require_once ($this->plugin_local . '/admin/SEUR_orders_metabox.php') ; require_once ($this->plugin_local . '/admin/SEUR_admin_class.php') ; $this->admin_class = new SEUR_admin_class() ; register_activation_hook( __FILE__, array( 'SEUR', 'activacion' ) ) ; register_deactivation_hook( __FILE__, array( 'SEUR', 'desactivacion' ) ) ; } else { require_once ( $this->plugin_local . '/public/SEUR_public_class.php') ; SEUR()->public = new  SEUR_public() ;  } require_once ($this->plugin_local . '/common/SEUR_Status_Orders.php') ; $this->Estado_Pedidos = new SEUR_Status_Orders() ; $this->ToolBar = new SEUR_toolbar() ; do_action( 'SEUR_init') ;  } function activacion() { $this->adminNotice('Plugin SEUR activado.') ;  } function desactivacion() { $this->adminNotice('Plugin SEUR desactivado.') ;  } function SEUR_end_plugin_Load() { do_action( 'SEUR_framework_loaded') ;  } function SEUR_end_works() { do_action( 'SEUR_shutdown') ;  } public function WC_version_check( $version = '2.6.1' ) { if ( function_exists( 'WC' ) && ( version_compare( WC()->version, $version, "<" ) )) { return false ;  } return true ;  } function is_active( $plugin ) { $network_active = false ; if ( is_multisite() ) { $plugins = get_site_option( 'active_sitewide_plugins' ) ; if ( isset( $plugins[$plugin] ) ) { $network_active = true ;  }  } return in_array( $plugin, get_option( 'active_plugins' ) ) || $network_active ;  } public function get_plugin_slug() { return $this->plugin_slug ;  } public static function get_instance() { if ( null == self::$instance ) { self::$instance = new self ;  } return self::$instance ;  } public function adminNotice($aviso , $tipo = 'updated') { if (class_exists('SEUR_AdminPageFramework_AdminNotice')) { new SEUR_AdminPageFramework_AdminNotice($aviso , array( 'class' => $tipo )) ; } else { add_action( 'admin_notices', 'no_admin_notices' ) ;  }  } private function no_admin_notices($aviso , $tipo = 'updated') { echo '<div class="'.$tipo.'"> <p>'.$aviso.'</p></div>' ;  } public static function XD( $Variable, $height = '300px', $print = true) { $debug = '' ; if(is_super_admin()) { if($print) $debug .= '<pre style="text-align=left;max-height:' . $height .  '; overflow: auto;">' ; if ( is_array($Variable )) { $debug .= print_r($Variable, true) ; } else if (is_object($Variable)) { $debug .= print_r((array)$Variable, true) ; } else { $debug .=  var_export($Variable, true) ;  } if($print)$debug .= '<br/></pre>' ;  } if($print ) echo $debug ; else
return $debug ;  } public function log( $log ) { if ( is_array( $log ) ) { error_log( 'SEUR: ' .  print_r( $log, true ) ) ; } else if (is_object($log)) { error_log( 'SEUR: ' .  print_r( (array) $log, true ) ) ; } else { error_log( 'SEUR: ' . var_export($log, true)) ;  }  }  } class SEUR_toolbar { function __construct() { add_action('admin_bar_menu', array($this, 'SEUR_set_toolbar'), 9998) ; add_action('wp_footer', array($this, 'print_toolbar_code')) ;  } public function print_toolbar_code() { ?>
<style type="text/css">#wp-admin-bar-SEUR .SEUR-toolbar-child{cursor:pointer}#wp-admin-bar-SEUR .SEUR-toolbar-child:hover{background-color:#0077bb}</style>
<?php } function SEUR_set_toolbar($wp_admin_bar) { $SEUR_OK = SEUR()->SOAP->Estado()['ALL'] ; $bg_color =  'background-color:'. ($SEUR_OK ? '#0a0' : '#a00') ; $wp_admin_bar->add_node ( array ( 'id' => 'SEUR' , 'title' => '<img style="height: 24px; padding: 2px 5px; margin: 2px 0px; border-radius: 4px;' . $bg_color . '" src="' . SEUR()->plugin_url . 'assets/images/boton-seur.png" alt="SEUR DPDgroup">' , 'href' =>  get_site_url() . '/wp-admin/admin.php?page=seur_dashboard' , 'meta' => array('class' => 'SEUR-toolbar-menu' )  ) ) ; $wp_admin_bar->add_node ( array ( 'id'    => 'seur_envios' , 'parent' => 'SEUR' , 'title' => 'Envíos' , 'meta' => array("class" => "SEUR-toolbar-parent" )  ) ) ; $wp_admin_bar->add_node ( array ( 'id'    => 'seur_paqueteria' , 'parent' => 'seur_envios' , 'title' => 'En paquetería' , 'href'  => get_site_url() .  '/wp-admin/edit.php?post_status=wc-seur_paqueteria&post_type=shop_order' , 'meta' => array("class" => "SEUR-toolbar-child" )  ) ) ; $wp_admin_bar->add_node ( array ( 'id'    => 'seur_esperando_seur' , 'parent' => 'seur_envios' , 'title' => 'Esperando datos' , 'href'  => get_site_url() .  '/wp-admin/edit.php?post_status=wc-seur_esperando&post_type=shop_order' , 'meta' => array("class" => "SEUR-toolbar-child" )  ) ) ; $wp_admin_bar->add_node ( array ( 'id'    => 'seur_transito' , 'parent' => 'seur_envios' , 'title' => 'En tránsito' , 'href'  => get_site_url() .  '/wp-admin/edit.php?post_status=wc-seur_transito&post_type=shop_order' , 'meta' => array("class" => "SEUR-toolbar-child" )  ) ) ; $wp_admin_bar->add_node ( array ( 'id'    => 'seur_entregado' , 'parent' => 'seur_envios' , 'title' => 'Entregados' , 'href'  => get_site_url() .  '/wp-admin/edit.php?post_status=wc-seur_entregado&post_type=shop_order' , 'meta' => array("class" => "SEUR-toolbar-child" )  ) ) ; if( $SEUR_OK ) { $wp_admin_bar->add_node ( array ( 'id'    => 'seur_manifiestos' , 'parent' => 'SEUR' , 'title' => 'Manifiesto' , 'href'  => get_site_url() .  '/wp-admin/admin.php?page=seur_manifiestos' , 'meta'  => array() , 'meta' => array("class" => "SEUR-toolbar-parent" )  ) ) ; $wp_admin_bar->add_node ( array ( 'id'    => 'seur_seguimientos' , 'parent' => 'SEUR' , 'title' => 'Seguimientos' , 'href'  => get_site_url() .  '/wp-admin/admin.php?page=seur_seguimientos' , 'meta'  => array() , 'meta' => array("class" => "SEUR-toolbar-parent" )  ) ) ; $wp_admin_bar->add_node ( array ( 'id'    => 'seur_recogida' , 'parent' => 'SEUR' , 'title' => 'Recogida' , 'href'  => get_site_url() .  '/wp-admin/admin.php?page=seur_recogidas' , 'meta'  => array() , 'meta' => array("class" => "SEUR-toolbar-parent" )  ) ) ; $wp_admin_bar->add_node ( array ( 'id'    => 'seur_nomenclator' , 'parent' => 'SEUR' , 'title' => 'Nomenclator' , 'href'  => get_site_url() .  '/wp-admin/admin.php?page=seur_nomenclator' , 'meta'  => array() , 'meta' => array("class" => "SEUR-toolbar-parent" )  ) ) ; $wp_admin_bar->add_node ( array ( 'id'    => 'seur_tarifas' , 'parent' => 'SEUR' , 'title' => 'Tarifas' , 'href'  => get_site_url() .  '/wp-admin/admin.php?page=seur_tarifas' , 'meta'  => array() , 'meta' => array("class" => "SEUR-toolbar-parent" )  ) ) ; } else { $wp_admin_bar->add_node ( array ( 'id'    => 'seur_configuracion' , 'parent' => 'SEUR' , 'title' => 'Configuración' , 'href'  => get_site_url() .  '/wp-admin/admin.php?page=seur_configuracion' , 'meta'  => array() , 'meta' => array("class" => "SEUR-toolbar-parent" )  ) ) ;  }  }  } 