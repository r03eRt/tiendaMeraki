<?php
if ( ! defined( 'ABSPATH' ) ) exit ; class SEUR_Status_Orders { private $custom_status = array() ; public function __construct() { $this->SEUR_crea_estados() ; add_filter ( 'wc_order_statuses'				, array( $this, 'SEUR_add_order_statuses' )					,1		) ; if(is_admin()) { add_action ( 'wp_print_scripts'  			, array( $this, 'SEUR_add_custom_order_status_icons' ) 				) ; add_action ( 'admin_footer'					, array( $this, 'SEUR_custom_bulk_admin_footer')			,10		) ; add_filter ( 'woocommerce_reports_get_order_report_data_args', array( $this, 'SEUR_Lista_formas_pago') ,10 ,2 ) ;  } add_action ( 'SEUR_cambia_estado_pedido' 	, 		array( $this, 'SEUR_cambia_estado_pedido' )		,10 ,2 ) ; return $this ;  } public function Estados() { return $this->custom_status ;  } function SEUR_Lista_formas_pago( $args ) { foreach($this->custom_status as $Key => $status ) $args['order_status'][] = $Key ; return $args ;  } function SEUR_crea_estados() { $this->SEUR_register_estaus( 'seur_paqueteria', array ( 'label'				=> __('Pedido en paquetería','seur') , 'plural' 			=> __('Pedidos en paquetería','seur') , 'font-family' 		=> 'FontAwesome' , 'content'			=> '\f16b' , 'color'				=> '#cc5f00' , 'description'		=> 'Correo que se enviará cuando cuando el pedido pasa a la sección de paquetería.' , 'heading'			=> __('Pedido en paquetería','seur') , 'condicion_disparo'	=> 'cualquiera_a_seur_paqueteria' ,  ) ) ; $this->SEUR_register_estaus( 'seur_esperando', array ( 'label'				=> __('Esperando datos SEUR','seur') , 'font-family' 		=> 'FontAwesome' , 'content'			=> '\f087' , 'color'				=> '#319e60' , 'description'			=> 'Correo que se enviará cuando se están esperando datos de SEUR.' , 'heading'			=> __('Esperando a SEUR','seur') , 'condicion_disparo'	=> 'seur_paqueteria_a_seur_esperando' ,  ) ) ; $this->SEUR_register_estaus( 'seur_transito', array ( 'label'				=> __('Envío en tránsito','seur') , 'plural' 			=> __('Envíos en tránsito','seur') , 'font-family' 		=> 'WooCommerce' , 'content'			=> '\e019' , 'color'				=> '#0066bf' , 'description'			=> 'Correo que se enviará cuando tengamos datos de SEUR, cuando el pedido está en transito.' , 'heading'			=> __('Pedido en transito','seur') , 'condicion_disparo'	=> 'seur_esperando_a_seur_transito' ,  ) ) ; $this->SEUR_register_estaus( 'seur_entregado', array ( 'label'				=> __('Entregado al cliente','seur') , 'plural' 			=> __('Entregados al cliente','seur') , 'font-family' 		=> 'Dashicons' , 'content'			=> '\f110' , 'color'				=> '#dd9933' , 'description'		=> 'Correo que se enviará cuando SEUR notifica que el pedido ha sido entregado.' , 'heading'			=> __('Pedido entregado','seur') , 'condicion_disparo'	=> 'seur_transito_a_seur_entregado' ,  ) ) ;  } function SEUR_register_estaus( $status, $args ) { if( !isset($args['plural']) ) $args['plural'] = $args['label'] ; $args['label_count'] = _n_noop(  $args['label'] . ' <span class="count">(%s)</span>', $args['plural'] . ' <span class="count">(%s)</span>' ) ; $this->custom_status[$status] = array_merge( array ( 'label'                     => 'Estado' , 'description'				=> 'Descripción' , 'public'                    => false , 'exclude_from_search'       => false , 'show_in_admin_all_list'    => true , 'show_in_admin_status_list' => true , 'label_count'               => _n_noop(  'Estado <span class="count">(%s)</span>', 'Estados <span class="count">(%s)</span>' ) , 'font-family' 				=> '' , 'content'					=> '' , 'color'						=> '' , 'condicion_disparo'			=> 'ninguno' , 'heading'					=> '' , 'subject'					=> '' , 'body_text'					=> '' , ) , $args )  ; register_post_status( 'wc-'. $status , $this->custom_status[$status] ) ;  } function SEUR_add_order_statuses( $order_statuses ) { $new_order_statuses = array() ; foreach ( $order_statuses as $key => $status ) { $new_order_statuses[ $key ] = $status ; if ( 'wc-processing' === $key ) { foreach($this->custom_status as $Key => $status) { $new_order_statuses['wc-'. $Key] = $status['label'] ;  }  }  } return $new_order_statuses ;  } function SEUR_custom_bulk_admin_footer( ) { global $post_type ; if($post_type == 'shop_order') { ?>
<script type="text/javascript">
jQuery(document).ready(function() { <?php foreach($this->custom_status as $Key => $status) { ?> 
jQuery('<option>').val('mark_<?php echo $Key ?>').text('<?php echo $status['label'] ?>').appendTo("select[name='action']") ; jQuery('<option>').val('mark_<?php echo $Key ?>').text('<?php echo $status['label'] ?>').appendTo("select[name='action2']") ; <?php } ?> } ) ; </script>
<?php }  } function SEUR_add_custom_order_status_icons() { global $post_type ; if( $post_type != 'shop_order') return ; echo '<style>' ; $Cab_St = '' ; foreach($this->custom_status as $Key => $status ) $Cab_St .= '.widefat .column-order_status mark.' . $Key. ':after,' ; echo trim($Cab_St , ',') ; echo '{ speak: none; font-weight: 400; font-variant: normal; text-transform: none; line-height: 1; -webkit-font-smoothing: antialiased; margin: 0; text-indent: 0 ; position: absolute; top: 0; left: 0; width: 100%; height: 100%; text-align: center;	}' ; foreach($this->custom_status as $Key => $status) { echo '.widefat .column-order_status mark.' . $Key . ':after { font-family: "' . $status['font-family'].'"; content: "' . $status['content'] .'"; color: ' . $status['color'] . '}' ;  } echo '</style>' ;  } public function SEUR_cambia_estado_pedido( $order_id, $estado ) { $Comentario ='' ; $nuevo_estado = 'none' ; switch ($estado) { case 'paqueteria' : $Comentario = __('SEUR: Pedido en paquetería listo para generar envío.','seur') ; $nuevo_estado = 'seur_paqueteria' ; break ; case 'crea_envio' : $Comentario = __('SEUR: El envío a sido generado, pedido listo para recoger por SEUR.','seur') ; $nuevo_estado = 'seur_esperando' ; break ; case 'en_seur' : $Comentario = __('SEUR: El paquete está en poder de SEUR.','seur') ; $nuevo_estado = 'seur_transito' ; break ; case 'entregado' : $Comentario = __('SEUR: El paquete ha sido entregado.','seur') ; $nuevo_estado = 'seur_entregado' ; break ; default : $nuevo_estado = 'none' ;  } if( $nuevo_estado != 'none') { $order = new WC_Order($order_id) ; if ($order->post_status != $nuevo_estado ) { do_action( 'SEUR_envia_email', $order_id, $estado, $nuevo_estado ) ; $order->update_status( $nuevo_estado , $Comentario ) ;  }  }  }  } 